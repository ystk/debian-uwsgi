Origin: https://github.com/apache/httpd/commit/fa7f3753066ce9f323a217252b3a7798c9324fb7
Origin: https://bz.apache.org/bugzilla/show_bug.cgi?id=65616#c2
Reviewed-by: Sylvain Beucler <beuc@debian.org>
Last-Update: 2021-10-20

From fa7f3753066ce9f323a217252b3a7798c9324fb7 Mon Sep 17 00:00:00 2001
From: Yann Ylavic <ylavic@apache.org>
Date: Sat, 9 Oct 2021 15:22:00 +0000
Subject: [PATCH] mod_proxy_uwsgi: Remove duplicate slashes at the beginning of
 PATH_INFO.

To accommodate for configs like:
    ProxyPass /uwsgi-pp uwsgi://localhost:8001/
which before r1892805 did not produce a leading double-slash in PATH_INFO.

Submitted by: rpluem



git-svn-id: https://svn.apache.org/repos/asf/httpd/httpd/trunk@1894074 13f79535-47bb-0310-9956-ffa450edef68
---
 changes-entries/uwsgi-path_info.txt |  2 ++
 modules/proxy/mod_proxy_uwsgi.c     | 12 ++++++++++--
 2 files changed, 12 insertions(+), 2 deletions(-)
 create mode 100644 changes-entries/uwsgi-path_info.txt

Index: uwsgi-2.0.7/apache2/mod_proxy_uwsgi.c
===================================================================
--- uwsgi-2.0.7.orig/apache2/mod_proxy_uwsgi.c
+++ uwsgi-2.0.7/apache2/mod_proxy_uwsgi.c
@@ -446,15 +446,23 @@ static int uwsgi_handler(request_rec *r,
 
     /* ADD PATH_INFO (unescaped) */
     u_path_info = ap_strchr(url + sizeof(UWSGI_SCHEME) + 2, '/');
-    if (!u_path_info || ap_unescape_url(u_path_info) != OK) {
+    if (!u_path_info) {
+        u_path_info = apr_pstrdup(r->pool, "/");
+    }
+    else if (ap_unescape_url(u_path_info) != OK) {
        ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, r,
                       "unable to decode uwsgi uri: %s",
                       url);
         return HTTP_INTERNAL_SERVER_ERROR;
     }
+    else {
+        /* Remove duplicate slashes at the beginning of PATH_INFO */
+        while (u_path_info[1] == '/') {
+            u_path_info++;
+        }
+    }
     apr_table_add(r->subprocess_env, "PATH_INFO", u_path_info);
 
-
     /* Create space for state information */
     status = ap_proxy_acquire_connection(UWSGI_SCHEME, &backend, worker,
                                          r->server);
