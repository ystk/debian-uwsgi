Origin: https://github.com/apache/httpd/commit/6d9672bf096592fe16c1840f73fa947fd458ee68
Reviewed-by: Sylvain Beucler <beuc@debian.org>
Last-Update: 2021-09-25

From 6d9672bf096592fe16c1840f73fa947fd458ee68 Mon Sep 17 00:00:00 2001
From: Yann Ylavic <ylavic@apache.org>
Date: Fri, 3 Sep 2021 17:00:07 +0000
Subject: [PATCH] Merge r1892805 from trunk:

mod_proxy_uwsgi: Fix PATH_INFO setting for generic worker.

When the generic "proxy:reverse" worker is selected for an uwsgi scheme, the
worker name is irrelevant so uwscgi_handler() should point to the PATH_INFO
directly from the given URL.


Submitted by: ylavic
Reviewed by: ylavic, covener, rpluem


git-svn-id: https://svn.apache.org/repos/asf/httpd/httpd/branches/2.4.x@1892875 13f79535-47bb-0310-9956-ffa450edef68
---
 changes-entries/uwsgi_path_info.txt |  1 +
 apache2/mod_proxy_uwsgi.c     | 22 +++++-----------------
 2 files changed, 6 insertions(+), 17 deletions(-)
 create mode 100644 changes-entries/uwsgi_path_info.txt

Index: uwsgi-2.0.7/apache2/mod_proxy_uwsgi.c
===================================================================
--- uwsgi-2.0.7.orig/apache2/mod_proxy_uwsgi.c
+++ uwsgi-2.0.7/apache2/mod_proxy_uwsgi.c
@@ -436,6 +436,7 @@ static int uwsgi_handler(request_rec *r,
     apr_pool_t *p = r->pool;
     apr_uri_t *uri = apr_palloc(r->pool, sizeof(*uri));
     char server_portstr[32];
+    char *u_path_info;
 
     if (strncasecmp(url, UWSGI_SCHEME "://", sizeof(UWSGI_SCHEME) + 2)) {
         ap_log_rerror(APLOG_MARK, APLOG_DEBUG, 0, r,
@@ -443,25 +444,15 @@ static int uwsgi_handler(request_rec *r,
         return DECLINED;
     }
 
-    // ADD PATH_INFO
-#if AP_MODULE_MAGIC_AT_LEAST(20111130,0)
-    size_t w_len = strlen(worker->s->name);
-#else
-    size_t w_len = strlen(worker->name);
-#endif
-    char *u_path_info = r->filename + 6 + w_len;
-    int delta = 0;
-    if (u_path_info[0] != '/') {
-        delta = 1;
-    }
-    int decode_status = ap_unescape_url(url+w_len-delta);
-    if (decode_status) {
+    /* ADD PATH_INFO (unescaped) */
+    u_path_info = ap_strchr(url + sizeof(UWSGI_SCHEME) + 2, '/');
+    if (!u_path_info || ap_unescape_url(u_path_info) != OK) {
        ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, r,
-                      "unable to decode uri: %s",
-                      url+w_len-delta);
+                      "unable to decode uwsgi uri: %s",
+                      url);
         return HTTP_INTERNAL_SERVER_ERROR;
     }
-    apr_table_add(r->subprocess_env, "PATH_INFO", url+w_len-delta);
+    apr_table_add(r->subprocess_env, "PATH_INFO", u_path_info);
 
 
     /* Create space for state information */
