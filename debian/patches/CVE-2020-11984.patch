Description: Error out on HTTP header larger than 16K
 The uwsgi protocol does not let us serialize more than 16K of HTTP header,
 so fail early with 500 if it happens.

--- a/apache2/mod_proxy_uwsgi.c
+++ b/apache2/mod_proxy_uwsgi.c
@@ -39,6 +39,7 @@
 #include "apr_hooks.h"
 #include "apr_optional_hooks.h"
 #include "apr_buckets.h"
+#include "apr.h"
 
 #include "httpd.h"
 #include "http_config.h"
@@ -136,7 +137,7 @@
     int j;
 
     apr_size_t headerlen = 4;
-    uint16_t pktsize, keylen, vallen;
+    apr_size_t pktsize, keylen, vallen;
 
     ap_add_common_vars(r);
     ap_add_cgi_vars(r);
@@ -170,6 +171,15 @@
         headerlen += 2 + strlen(env[j].key) + 2 + strlen(env[j].val) ;
     }
 
+    pktsize = headerlen - 4;
+    if (pktsize > APR_UINT16_MAX) {
+        ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, r, APLOGNO(10259)
+                      "can't send headers to %s:%u: packet size too "
+                      "large (%" APR_SIZE_T_FMT ")",
+                      conn->hostname, conn->port, pktsize);
+        return HTTP_INTERNAL_SERVER_ERROR;
+    }
+
     ptr = buf = apr_palloc(r->pool, headerlen);
 
     ptr+=4;
@@ -186,8 +196,6 @@
 	memcpy(ptr, env[j].val, vallen) ; ptr+=vallen;
     }
 
-    pktsize = headerlen-4;
-
     buf[0] = 0;
     buf[1] = (uint8_t) (pktsize & 0xff);
     buf[2] = (uint8_t) ((pktsize >> 8) & 0xff);
